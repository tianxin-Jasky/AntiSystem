const find=function(e){return document.querySelector(e)},sendMessage=chrome.tabs.sendMessage,onMessage=chrome.runtime.onMessage,query=chrome.tabs.query,container=find("#container"),showAddBtn=find("#showAddBtn"),addArea=find(".add-area"),cancelBtn=find("#cancelBtn"),confirmBtn=find("#confirmBtn"),accountBtnArea=find("#accountBtnArea"),accountNameInput=find("#accountName"),accountInput=find("#account"),passwordInput=find("#password");var socket,Wrongmail;const Plugin={initButton:function(){let e=this,t="",n={},o="",a="";for(let c in localStorage)localStorage.hasOwnProperty(c)&&(t=e.getStorage(c),o=(n=JSON.parse(t)).account,a=n.password,e.createButton(c))},bindEvent:function(){let e=this;accountBtnArea.addEventListener("click",function(t){t.stopPropagation();let n=t.target,o=t.target.className,a="",c={};"account-btn"===o?(a=n.parentNode.getAttribute("storage-key"),Wrongmail=a,c=JSON.parse(e.getStorage(a)),e.sendMsg(c.account,c.password)):"fa fa-trash"===o?(a=n.parentNode.parentNode.getAttribute("storage-key"),e.removeStorage(a),location.reload()):console.log("neither account-btn nor delete-btn.")},!1),showAddBtn.addEventListener("click",function(){addArea.style.display="block",showAddBtn.style.display="none"},!1),cancelBtn.addEventListener("click",function(){location.reload()},!1),confirmBtn.addEventListener("click",function(){let t=accountNameInput.value+"accountName!@#$",n=accountInput.value,o=passwordInput.value;if(""===t||""===n||""===o)return void console.info("input incomplete.");let a={account:n,password:o},c=JSON.stringify(a);e.setStorage(t,c),e.clearInput(),location.reload()},!1)},connectServer:function(){let e=this;socket=new WebSocket("ws://192.168.153.245:1234"),console.log("连接服务开始！"),socket.onopen=function(e){console.log("连接服务成功！")},console.log("连接服务结束！");var t="",n="",o="",a="",c=-1;socket.onmessage=function(i){var r=i.data.split("!@#%&");if(-1!=parseInt(r[0])){let i={MailNumber:parseInt(r[0])},d=JSON.stringify(i);e.setStorage("!！@@##¥",d);for(var s=1,l=0;s<r.length;s++,l++){switch(l%4){case 0:t=r[s];break;case 1:n=r[s];break;case 2:o=r[s];break;case 3:a=r[s],c++;let i={Mailsubject:t,Mailtime:n,Mailsender:o,Mailjudge:a},d=JSON.stringify(i);e.setStorage(c,d)}}window.location="/MailShield_HTML/result.html"}else e.removeStorage(Wrongmail),window.location="/MailShield_HTML/retry.html"},socket.onclose=function(e){console.log("服务器的关闭")},socket.onerror=function(e){console.log("服务器的连接失败")}},sendMsg:function(e,t){var n=e+"!@#%&"+t;socket.send(n)},showPanel:function(){addArea.style.display="block",showAddBtn.style.display="none"},hidePanel:function(){addArea.style.display="none",showAddBtn.style.display="block"},setStorage:function(e,t){localStorage.setItem(e,t)},getStorage:function(e){return localStorage.getItem(e)},removeStorage:function(e){localStorage.removeItem(e)},clearInput:function(){accountNameInput.value="",accountInput.value="",passwordInput.value=""},createButton:function(e,t,n){let o=document.createElement("div");o.className="button-row",o.setAttribute("storage-key",e);let a=document.createElement("button");a.className="account-btn";var c=e.replace("accountName!@#$","");a.innerText=c;let i=document.createElement("div");i.className="icon-container";let r=document.createElement("i");r.className="fa fa-trash",i.appendChild(r),o.appendChild(a),o.appendChild(i),accountBtnArea.appendChild(o)},fillTheBlank:function(e,t){query({active:!0,currentWindow:!0},function(n){sendMessage(n[0].id,{action:"FILL_THE_BLANK",account:e,password:t},function(e){console.log(e)})})},init:function(){this.initButton(),this.connectServer(),this.bindEvent()}};Plugin.init();